import{P as L}from"./chunk-ZP24KMQ5.js";import{Q as p,U as m,a as n,b as u,ja as c}from"./chunk-4ZPWDUXV.js";var b=class h{constructor(e){this.logger=e;this.config=this.getConfig(),this.logger.debugLog("Data service initialized",{environment:window.location.href.includes("localhost")?"localhost":"production",siteUrl:this.config.siteUrl,apiPath:this.config.apiPath})}config;getConfig(){return window.location.href.includes("localhost")?(this.logger.debugLog("Running in localhost development mode"),{siteUrl:"http://localhost:3000",apiPath:""}):(this.logger.debugLog("Running in production SharePoint mode"),{siteUrl:"https://collab.napma.nato.int/grc",apiPath:"/_api/web"})}cacheState=c({isInitialized:!1,lastUpdated:null,initializationError:null},{});risksState=c({isLoaded:!1,lastUpdated:null,error:null},{});objectivesState=c({isLoaded:!1,lastUpdated:null,error:null},{});criticalAssetsState=c({isLoaded:!1,lastUpdated:null,error:null},{});treatmentsState=c({isLoaded:!1,lastUpdated:null,error:null},{});userState=c({isLoaded:!1,lastUpdated:null,error:null},{});_risks=[];_objectives=[];_criticalAssets=[];_treatments=[];_user=null;risks(){return this._risks}objectives(){return this._objectives}criticalAssets(){return this._criticalAssets}treatments(){return this._treatments}user(){return this._user}isInitialized(){return this.cacheState().isInitialized}lastUpdated(){return this.cacheState().lastUpdated}risksLoaded(){return this.risksState().isLoaded}objectivesLoaded(){return this.objectivesState().isLoaded}criticalAssetsLoaded(){return this.criticalAssetsState().isLoaded}treatmentsLoaded(){return this.treatmentsState().isLoaded}userLoaded(){return this.userState().isLoaded}async initializeCache(){if(this.cacheState().isInitialized){this.logger.debugLog("Cache already initialized, skipping initialization");return}this.logger.debugLog("Starting cache initialization");try{this._user=await this.loadUser(),this.userState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("User loaded",this._user);let[e,t,s,i]=await Promise.all([this.loadRisks(),this.loadObjectives(),this.loadCriticalAssets(),this.loadTreatments()]);this._risks=e,this.risksState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this._objectives=t,this.objectivesState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this._criticalAssets=s,this.criticalAssetsState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this._treatments=i,this.treatmentsState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.cacheState.set({isInitialized:!0,lastUpdated:new Date,initializationError:null}),this.logger.debugLog("Cache initialization completed successfully",{risksCount:e.length,objectivesCount:t.length,criticalAssetsCount:s.length,treatmentsCount:i.length})}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.cacheState.set({isInitialized:!1,lastUpdated:null,initializationError:t}),this.logger.debugLog("Cache initialization failed",e),e}}async forceRefreshCache(){this.logger.debugLog("Force refreshing entire cache"),this.cacheState.set({isInitialized:!1,lastUpdated:null,initializationError:null}),await this.initializeCache()}async invalidateUser(){this.logger.debugLog("Invalidating user cache");try{this._user=await this.loadUser(),this.userState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("User cache refreshed",this._user)}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.userState.set({isLoaded:!1,lastUpdated:null,error:t}),this.logger.debugLog("User cache refresh failed",e),e}}async invalidateRisks(){this.logger.debugLog("Invalidating risks cache");try{this._risks=await this.loadRisks(),this.risksState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("Risks cache refreshed",{count:this._risks.length})}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.risksState.set({isLoaded:!1,lastUpdated:null,error:t}),this.logger.debugLog("Risks cache refresh failed",e),e}}async invalidateObjectives(){this.logger.debugLog("Invalidating objectives cache");try{this._objectives=await this.loadObjectives(),this.objectivesState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("Objectives cache refreshed",{count:this._objectives.length})}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.objectivesState.set({isLoaded:!1,lastUpdated:null,error:t}),this.logger.debugLog("Objectives cache refresh failed",e),e}}async invalidateCriticalAssets(){this.logger.debugLog("Invalidating critical assets cache");try{this._criticalAssets=await this.loadCriticalAssets(),this.criticalAssetsState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("Critical assets cache refreshed",{count:this._criticalAssets.length})}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.criticalAssetsState.set({isLoaded:!1,lastUpdated:null,error:t}),this.logger.debugLog("Critical assets cache refresh failed",e),e}}async invalidateTreatments(){this.logger.debugLog("Invalidating treatments cache");try{this._treatments=await this.loadTreatments(),this.treatmentsState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("Treatments cache refreshed",{count:this._treatments.length})}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.treatmentsState.set({isLoaded:!1,lastUpdated:null,error:t}),this.logger.debugLog("Treatments cache refresh failed",e),e}}clearCache(){this.logger.debugLog("Clearing cache"),this._risks=[],this._objectives=[],this._criticalAssets=[],this._treatments=[],this._user=null,this.cacheState.set({isInitialized:!1,lastUpdated:null,initializationError:null}),this.risksState.set({isLoaded:!1,lastUpdated:null,error:null}),this.objectivesState.set({isLoaded:!1,lastUpdated:null,error:null}),this.criticalAssetsState.set({isLoaded:!1,lastUpdated:null,error:null}),this.treatmentsState.set({isLoaded:!1,lastUpdated:null,error:null}),this.userState.set({isLoaded:!1,lastUpdated:null,error:null})}buildApiUrl(e){return`${this.config.siteUrl}${this.config.apiPath}${e}`}getHeaders(e=!1){let t={Accept:"application/json;odata=verbose","Content-Type":"application/json;odata=verbose"};if(e){let s=this.getRequestDigest();s&&(t["X-RequestDigest"]=s)}return t}getRequestDigest(){let e=document.querySelector("#__REQUESTDIGEST");return e?e.value:null}async queryList(e,t,s,i,a){this.logger.debugLog(`Querying SharePoint list: ${e}`,{select:t,filter:s,orderBy:i,expand:a});let d=`/Lists/getbytitle('${e}')/Items`,r=[];t&&r.push(`$select=${t}`),s&&r.push(`$filter=${s}`),i&&r.push(`$orderby=${i}`),a&&r.push(`$expand=${a}`),r.length>0&&(d+="?"+r.join("&"));let g=this.buildApiUrl(d);this.logger.debugLog(`Fetching data from URL: ${g}`);try{let o=await fetch(g,{method:"GET",headers:this.getHeaders(),credentials:"include"});if(!o.ok){let f=await o.text();throw this.logger.debugLog("HTTP Error Details",{status:o.status,statusText:o.statusText,url:g,responseBody:f}),new Error(`SharePoint query failed: ${o.status} ${o.statusText}`)}let l=await o.json();return this.logger.debugLog(`Raw JSON response from ${e}`,l),Array.isArray(l)?l:l.d&&l.d.results?l.d.results:l.d&&Array.isArray(l.d)?l.d:(this.logger.debugLog("Unexpected response format",l),[])}catch(o){throw this.logger.debugLog(`Error querying list ${e}`,{error:o,message:o instanceof Error?o.message:String(o),stack:o instanceof Error?o.stack:void 0,url:g}),o}}async addListItem(e,t){this.logger.debugLog(`Adding item to SharePoint list: ${e}`,t);let s=`/Lists/getbytitle('${e}')/Items`,i=this.buildApiUrl(s);this.logger.debugLog(`POST request to URL: ${i}`);let a=n({__metadata:{type:`SP.Data.${e}ListItem`}},t);try{let d=await fetch(i,{method:"POST",headers:this.getHeaders(!0),credentials:"include",body:JSON.stringify(a)});if(!d.ok)throw new Error(`SharePoint add failed: ${d.status} ${d.statusText}`);let r=await d.json();return this.logger.debugLog(`Item added successfully to ${e}`,r.d),r.d}catch(d){throw this.logger.debugLog(`Error adding item to ${e}`,d),d}}async updateListItem(e,t,s){this.logger.debugLog(`Updating item in SharePoint list: ${e}`,{itemId:t,itemData:s});let i=`/Lists/getbytitle('${e}')/Items(${t})`,a=this.buildApiUrl(i);this.logger.debugLog(`MERGE request to URL: ${a}`);let d=n({__metadata:{type:`SP.Data.${e}ListItem`}},s);try{let r=await fetch(a,{method:"POST",headers:u(n({},this.getHeaders(!0)),{"X-HTTP-Method":"MERGE","IF-MATCH":"*"}),credentials:"include",body:JSON.stringify(d)});if(!r.ok)throw new Error(`SharePoint update failed: ${r.status} ${r.statusText}`);this.logger.debugLog(`Item updated successfully in ${e}`,{itemId:t})}catch(r){throw this.logger.debugLog(`Error updating item in ${e}`,r),r}}async deleteListItem(e,t){this.logger.debugLog(`Deleting item from SharePoint list: ${e}`,{itemId:t});let s=`/Lists/getbytitle('${e}')/Items(${t})`,i=this.buildApiUrl(s);this.logger.debugLog(`DELETE request to URL: ${i}`);try{let a=await fetch(i,{method:"POST",headers:u(n({},this.getHeaders(!0)),{"X-HTTP-Method":"DELETE","IF-MATCH":"*"}),credentials:"include"});if(!a.ok)throw new Error(`SharePoint delete failed: ${a.status} ${a.statusText}`);this.logger.debugLog(`Item deleted successfully from ${e}`,{itemId:t})}catch(a){throw this.logger.debugLog(`Error deleting item from ${e}`,a),a}}async loadUser(){this.logger.debugLog("Loading current user");let e=this.buildApiUrl("/currentuser");this.logger.debugLog(`Fetching current user from URL: ${e}`);try{let t=await fetch(e,{method:"GET",headers:this.getHeaders(),credentials:"include"});if(!t.ok)throw new Error(`Failed to load user: ${t.status}`);return(await t.json()).d}catch(t){throw this.logger.debugLog("Error loading user",t),t}}async loadRisks(){return this.queryList("Risks","Id,Title,Description,Category,OwnerId,OrgDivision,DateIdentified,Created,Modified,AuthorId,Author/Id,Author/Title,Author/Name,Author/EMail",void 0,void 0,"Author")}async loadObjectives(){return this.queryList("Objectives")}async loadCriticalAssets(){return this.queryList("CriticalAssets")}async loadTreatments(){return this.queryList("Treatments")}async addRisk(e){let t=await this.addListItem("Risks",e);return this._risks.push(t),this.logger.debugLog("Risk added to cache",t),t}async updateRisk(e,t){await this.updateListItem("Risks",e,t);let s=this._risks.findIndex(i=>i.Id===e);s!==-1&&(this._risks[s]=n(n({},this._risks[s]),t),this.logger.debugLog("Risk updated in cache",{riskId:e}))}async deleteRisk(e){await this.deleteListItem("Risks",e),this._risks=this._risks.filter(t=>t.Id!==e),this.logger.debugLog("Risk deleted from cache",{riskId:e})}async addObjective(e){let t=await this.addListItem("Objectives",e);return this._objectives.push(t),this.logger.debugLog("Objective added to cache",t),t}async updateObjective(e,t){await this.updateListItem("Objectives",e,t);let s=this._objectives.findIndex(i=>i.Id===e);s!==-1&&(this._objectives[s]=n(n({},this._objectives[s]),t),this.logger.debugLog("Objective updated in cache",{objectiveId:e}))}async deleteObjective(e){await this.deleteListItem("Objectives",e),this._objectives=this._objectives.filter(t=>t.Id!==e),this.logger.debugLog("Objective deleted from cache",{objectiveId:e})}async addCriticalAsset(e){let t=await this.addListItem("CriticalAssets",e);return this._criticalAssets.push(t),this.logger.debugLog("Critical asset added to cache",t),t}async updateCriticalAsset(e,t){await this.updateListItem("CriticalAssets",e,t);let s=this._criticalAssets.findIndex(i=>i.Id===e);s!==-1&&(this._criticalAssets[s]=n(n({},this._criticalAssets[s]),t),this.logger.debugLog("Critical asset updated in cache",{assetId:e}))}async deleteCriticalAsset(e){await this.deleteListItem("CriticalAssets",e),this._criticalAssets=this._criticalAssets.filter(t=>t.Id!==e),this.logger.debugLog("Critical asset deleted from cache",{assetId:e})}async addTreatment(e){let t=await this.addListItem("Treatments",e);return this._treatments.push(t),this.logger.debugLog("Treatment added to cache",t),t}async updateTreatment(e,t){await this.updateListItem("Treatments",e,t);let s=this._treatments.findIndex(i=>i.Id===e);s!==-1&&(this._treatments[s]=n(n({},this._treatments[s]),t),this.logger.debugLog("Treatment updated in cache",{treatmentId:e}))}async deleteTreatment(e){await this.deleteListItem("Treatments",e),this._treatments=this._treatments.filter(t=>t.Id!==e),this.logger.debugLog("Treatment deleted from cache",{treatmentId:e})}static \u0275fac=function(t){return new(t||h)(m(L))};static \u0275prov=p({token:h,factory:h.\u0275fac,providedIn:"root"})};export{b as a};
