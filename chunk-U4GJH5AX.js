import{P as p}from"./chunk-ZP24KMQ5.js";import{Q as m,U as L,a as r,b as u,ja as c}from"./chunk-4ZPWDUXV.js";var f=class g{constructor(e){this.logger=e;this.config=this.getConfig(),this.logger.debugLog("Data service initialized",{environment:window.location.href.includes("localhost")?"localhost":"production",siteUrl:this.config.siteUrl,apiPath:this.config.apiPath})}config;getConfig(){return window.location.href.includes("localhost")?(this.logger.debugLog("Running in localhost development mode"),{siteUrl:"http://localhost:3000",apiPath:""}):(this.logger.debugLog("Running in production SharePoint mode"),{siteUrl:"https://collab.napma.nato.int/grc",apiPath:"/_api/web"})}cacheState=c({isInitialized:!1,lastUpdated:null,initializationError:null},{});risksState=c({isLoaded:!1,lastUpdated:null,error:null},{});objectivesState=c({isLoaded:!1,lastUpdated:null,error:null},{});criticalAssetsState=c({isLoaded:!1,lastUpdated:null,error:null},{});treatmentsState=c({isLoaded:!1,lastUpdated:null,error:null},{});userState=c({isLoaded:!1,lastUpdated:null,error:null},{});causesState=c({isLoaded:!1,lastUpdated:null,error:null},{});consequencesState=c({isLoaded:!1,lastUpdated:null,error:null},{});controlsState=c({isLoaded:!1,lastUpdated:null,error:null},{});_risks=[];_objectives=[];_criticalAssets=[];_treatments=[];_causes=[];_consequences=[];_controls=[];_user=null;_selectedRisk=null;risks(){return this._risks}objectives(){return this._objectives}criticalAssets(){return this._criticalAssets}treatments(){return this._treatments}causes(){return this._causes}consequences(){return this._consequences}controls(){return this._controls}user(){return this._user}selectedRisk(){return this._selectedRisk}isInitialized(){return this.cacheState().isInitialized}lastUpdated(){return this.cacheState().lastUpdated}risksLoaded(){return this.risksState().isLoaded}objectivesLoaded(){return this.objectivesState().isLoaded}criticalAssetsLoaded(){return this.criticalAssetsState().isLoaded}treatmentsLoaded(){return this.treatmentsState().isLoaded}causesLoaded(){return this.causesState().isLoaded}consequencesLoaded(){return this.consequencesState().isLoaded}controlsLoaded(){return this.controlsState().isLoaded}userLoaded(){return this.userState().isLoaded}async initializeCache(){if(this.cacheState().isInitialized){this.logger.debugLog("Cache already initialized, skipping initialization");return}this.logger.debugLog("Starting cache initialization");try{this._user=await this.loadUser(),this.userState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("User loaded",this._user);let[e,t,s,i,o,n,a]=await Promise.all([this.loadRisks(),this.loadObjectives(),this.loadCriticalAssets(),this.loadTreatments(),this.loadCauses(),this.loadConsequences(),this.loadControls()]);this._risks=e,this.risksState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this._objectives=t,this.objectivesState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this._criticalAssets=s,this.criticalAssetsState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this._treatments=i,this.treatmentsState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this._causes=o,this.causesState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this._consequences=n,this.consequencesState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this._controls=a,this.controlsState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.cacheState.set({isInitialized:!0,lastUpdated:new Date,initializationError:null}),this.logger.debugLog("Cache initialization completed successfully",{risksCount:e.length,objectivesCount:t.length,criticalAssetsCount:s.length,treatmentsCount:i.length,causesCount:o.length,consequencesCount:n.length,controlsCount:a.length})}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.cacheState.set({isInitialized:!1,lastUpdated:null,initializationError:t}),this.logger.debugLog("Cache initialization failed",e),e}}async forceRefreshCache(){this.logger.debugLog("Force refreshing entire cache"),this.cacheState.set({isInitialized:!1,lastUpdated:null,initializationError:null}),await this.initializeCache()}async invalidateUser(){this.logger.debugLog("Invalidating user cache");try{this._user=await this.loadUser(),this.userState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("User cache refreshed",this._user)}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.userState.set({isLoaded:!1,lastUpdated:null,error:t}),this.logger.debugLog("User cache refresh failed",e),e}}async invalidateRisks(){this.logger.debugLog("Invalidating risks cache");try{this._risks=await this.loadRisks(),this.risksState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("Risks cache refreshed",{count:this._risks.length})}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.risksState.set({isLoaded:!1,lastUpdated:null,error:t}),this.logger.debugLog("Risks cache refresh failed",e),e}}async invalidateObjectives(){this.logger.debugLog("Invalidating objectives cache");try{this._objectives=await this.loadObjectives(),this.objectivesState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("Objectives cache refreshed",{count:this._objectives.length})}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.objectivesState.set({isLoaded:!1,lastUpdated:null,error:t}),this.logger.debugLog("Objectives cache refresh failed",e),e}}async invalidateCriticalAssets(){this.logger.debugLog("Invalidating critical assets cache");try{this._criticalAssets=await this.loadCriticalAssets(),this.criticalAssetsState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("Critical assets cache refreshed",{count:this._criticalAssets.length})}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.criticalAssetsState.set({isLoaded:!1,lastUpdated:null,error:t}),this.logger.debugLog("Critical assets cache refresh failed",e),e}}async invalidateTreatments(){this.logger.debugLog("Invalidating treatments cache");try{this._treatments=await this.loadTreatments(),this.treatmentsState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("Treatments cache refreshed",{count:this._treatments.length})}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.treatmentsState.set({isLoaded:!1,lastUpdated:null,error:t}),this.logger.debugLog("Treatments cache refresh failed",e),e}}async invalidateCauses(){this.logger.debugLog("Invalidating causes cache");try{this._causes=await this.loadCauses(),this.causesState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("Causes cache refreshed",{count:this._causes.length})}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.causesState.set({isLoaded:!1,lastUpdated:null,error:t}),this.logger.debugLog("Causes cache refresh failed",e),e}}async invalidateConsequences(){this.logger.debugLog("Invalidating consequences cache");try{this._consequences=await this.loadConsequences(),this.consequencesState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("Consequences cache refreshed",{count:this._consequences.length})}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.consequencesState.set({isLoaded:!1,lastUpdated:null,error:t}),this.logger.debugLog("Consequences cache refresh failed",e),e}}async invalidateControls(){this.logger.debugLog("Invalidating controls cache");try{this._controls=await this.loadControls(),this.controlsState.set({isLoaded:!0,lastUpdated:new Date,error:null}),this.logger.debugLog("Controls cache refreshed",{count:this._controls.length})}catch(e){let t=e instanceof Error?e.message:"Unknown error";throw this.controlsState.set({isLoaded:!1,lastUpdated:null,error:t}),this.logger.debugLog("Controls cache refresh failed",e),e}}clearCache(){this.logger.debugLog("Clearing cache"),this._risks=[],this._objectives=[],this._criticalAssets=[],this._treatments=[],this._user=null,this.cacheState.set({isInitialized:!1,lastUpdated:null,initializationError:null}),this.risksState.set({isLoaded:!1,lastUpdated:null,error:null}),this.objectivesState.set({isLoaded:!1,lastUpdated:null,error:null}),this.criticalAssetsState.set({isLoaded:!1,lastUpdated:null,error:null}),this.treatmentsState.set({isLoaded:!1,lastUpdated:null,error:null}),this.userState.set({isLoaded:!1,lastUpdated:null,error:null})}buildApiUrl(e){return`${this.config.siteUrl}${this.config.apiPath}${e}`}getHeaders(e=!1){let t={Accept:"application/json;odata=verbose","Content-Type":"application/json;odata=verbose"};if(e){let s=this.getRequestDigest();s&&(t["X-RequestDigest"]=s)}return t}getRequestDigest(){let e=document.querySelector("#__REQUESTDIGEST");return e?e.value:null}async queryList(e,t,s,i,o){this.logger.debugLog(`Querying SharePoint list: ${e}`,{select:t,filter:s,orderBy:i,expand:o});let n=`/Lists/getbytitle('${e}')/Items`,a=[];t&&a.push(`$select=${t}`),s&&a.push(`$filter=${s}`),i&&a.push(`$orderby=${i}`),o&&a.push(`$expand=${o}`),a.length>0&&(n+="?"+a.join("&"));let h=this.buildApiUrl(n);this.logger.debugLog(`Fetching data from URL: ${h}`);try{let d=await fetch(h,{method:"GET",headers:this.getHeaders(),credentials:"include"});if(!d.ok){let b=await d.text();throw this.logger.debugLog("HTTP Error Details",{status:d.status,statusText:d.statusText,url:h,responseBody:b}),new Error(`SharePoint query failed: ${d.status} ${d.statusText}`)}let l=await d.json();return this.logger.debugLog(`Raw JSON response from ${e}`,l),Array.isArray(l)?l:l.d&&l.d.results?l.d.results:l.d&&Array.isArray(l.d)?l.d:(this.logger.debugLog("Unexpected response format",l),[])}catch(d){throw this.logger.debugLog(`Error querying list ${e}`,{error:d,message:d instanceof Error?d.message:String(d),stack:d instanceof Error?d.stack:void 0,url:h}),d}}async addListItem(e,t){this.logger.debugLog(`Adding item to SharePoint list: ${e}`,t);let s=`/Lists/getbytitle('${e}')/Items`,i=this.buildApiUrl(s);this.logger.debugLog(`POST request to URL: ${i}`);let o=r({__metadata:{type:`SP.Data.${e}ListItem`}},t);try{let n=await fetch(i,{method:"POST",headers:this.getHeaders(!0),credentials:"include",body:JSON.stringify(o)});if(!n.ok)throw new Error(`SharePoint add failed: ${n.status} ${n.statusText}`);let a=await n.json();return this.logger.debugLog(`Item added successfully to ${e}`,a.d),a.d}catch(n){throw this.logger.debugLog(`Error adding item to ${e}`,n),n}}async updateListItem(e,t,s){this.logger.debugLog(`Updating item in SharePoint list: ${e}`,{itemId:t,itemData:s});let i=`/Lists/getbytitle('${e}')/Items(${t})`,o=this.buildApiUrl(i);this.logger.debugLog(`MERGE request to URL: ${o}`);let n=r({__metadata:{type:`SP.Data.${e}ListItem`}},s);try{let a=await fetch(o,{method:"POST",headers:u(r({},this.getHeaders(!0)),{"X-HTTP-Method":"MERGE","IF-MATCH":"*"}),credentials:"include",body:JSON.stringify(n)});if(!a.ok)throw new Error(`SharePoint update failed: ${a.status} ${a.statusText}`);this.logger.debugLog(`Item updated successfully in ${e}`,{itemId:t})}catch(a){throw this.logger.debugLog(`Error updating item in ${e}`,a),a}}async deleteListItem(e,t){this.logger.debugLog(`Deleting item from SharePoint list: ${e}`,{itemId:t});let s=`/Lists/getbytitle('${e}')/Items(${t})`,i=this.buildApiUrl(s);this.logger.debugLog(`DELETE request to URL: ${i}`);try{let o=await fetch(i,{method:"POST",headers:u(r({},this.getHeaders(!0)),{"X-HTTP-Method":"DELETE","IF-MATCH":"*"}),credentials:"include"});if(!o.ok)throw new Error(`SharePoint delete failed: ${o.status} ${o.statusText}`);this.logger.debugLog(`Item deleted successfully from ${e}`,{itemId:t})}catch(o){throw this.logger.debugLog(`Error deleting item from ${e}`,o),o}}async loadUser(){this.logger.debugLog("Loading current user");let e=this.buildApiUrl("/currentuser");this.logger.debugLog(`Fetching current user from URL: ${e}`);try{let t=await fetch(e,{method:"GET",headers:this.getHeaders(),credentials:"include"});if(!t.ok)throw new Error(`Failed to load user: ${t.status}`);return(await t.json()).d}catch(t){throw this.logger.debugLog("Error loading user",t),t}}async loadRisks(){return this.queryList("Risks","Id,Title,Description,Category,OwnerId,OrgDivision,DateIdentified,Created,Modified,AuthorId,Author/Id,Author/Title,Author/Name,Author/EMail",void 0,void 0,"Author")}async loadObjectives(){return this.queryList("Objectives")}async loadCriticalAssets(){return this.queryList("CriticalAssets")}async loadTreatments(){return this.queryList("Treatments")}async loadCauses(){return this.queryList("Causes")}async loadConsequences(){return this.queryList("Consequences")}async loadControls(){return this.queryList("Controls")}async addRisk(e){let t=await this.addListItem("Risks",e);return this._risks.push(t),this.logger.debugLog("Risk added to cache",t),t}async updateRisk(e,t){await this.updateListItem("Risks",e,t);let s=this._risks.findIndex(i=>i.Id===e);s!==-1&&(this._risks[s]=r(r({},this._risks[s]),t),this.logger.debugLog("Risk updated in cache",{riskId:e}))}async deleteRisk(e){await this.deleteListItem("Risks",e),this._risks=this._risks.filter(t=>t.Id!==e),this.logger.debugLog("Risk deleted from cache",{riskId:e})}async addObjective(e){let t=await this.addListItem("Objectives",e);return this._objectives.push(t),this.logger.debugLog("Objective added to cache",t),t}async updateObjective(e,t){await this.updateListItem("Objectives",e,t);let s=this._objectives.findIndex(i=>i.Id===e);s!==-1&&(this._objectives[s]=r(r({},this._objectives[s]),t),this.logger.debugLog("Objective updated in cache",{objectiveId:e}))}async deleteObjective(e){await this.deleteListItem("Objectives",e),this._objectives=this._objectives.filter(t=>t.Id!==e),this.logger.debugLog("Objective deleted from cache",{objectiveId:e})}async addCriticalAsset(e){let t=await this.addListItem("CriticalAssets",e);return this._criticalAssets.push(t),this.logger.debugLog("Critical asset added to cache",t),t}async updateCriticalAsset(e,t){await this.updateListItem("CriticalAssets",e,t);let s=this._criticalAssets.findIndex(i=>i.Id===e);s!==-1&&(this._criticalAssets[s]=r(r({},this._criticalAssets[s]),t),this.logger.debugLog("Critical asset updated in cache",{assetId:e}))}async deleteCriticalAsset(e){await this.deleteListItem("CriticalAssets",e),this._criticalAssets=this._criticalAssets.filter(t=>t.Id!==e),this.logger.debugLog("Critical asset deleted from cache",{assetId:e})}async addTreatment(e){let t=await this.addListItem("Treatments",e);return this._treatments.push(t),this.logger.debugLog("Treatment added to cache",t),t}async updateTreatment(e,t){await this.updateListItem("Treatments",e,t);let s=this._treatments.findIndex(i=>i.Id===e);s!==-1&&(this._treatments[s]=r(r({},this._treatments[s]),t),this.logger.debugLog("Treatment updated in cache",{treatmentId:e}))}async deleteTreatment(e){await this.deleteListItem("Treatments",e),this._treatments=this._treatments.filter(t=>t.Id!==e),this.logger.debugLog("Treatment deleted from cache",{treatmentId:e})}async addCause(e){let t=await this.addListItem("Causes",e);return this._causes.push(t),this.logger.debugLog("Cause added to cache",t),t}async updateCause(e,t){await this.updateListItem("Causes",e,t);let s=this._causes.findIndex(i=>i.Id===e);s!==-1&&(this._causes[s]=r(r({},this._causes[s]),t),this.logger.debugLog("Cause updated in cache",{causeId:e}))}async deleteCause(e){await this.deleteListItem("Causes",e),this._causes=this._causes.filter(t=>t.Id!==e),this.logger.debugLog("Cause deleted from cache",{causeId:e})}async addConsequence(e){let t=await this.addListItem("Consequences",e);return this._consequences.push(t),this.logger.debugLog("Consequence added to cache",t),t}async updateConsequence(e,t){await this.updateListItem("Consequences",e,t);let s=this._consequences.findIndex(i=>i.Id===e);s!==-1&&(this._consequences[s]=r(r({},this._consequences[s]),t),this.logger.debugLog("Consequence updated in cache",{consequenceId:e}))}async deleteConsequence(e){await this.deleteListItem("Consequences",e),this._consequences=this._consequences.filter(t=>t.Id!==e),this.logger.debugLog("Consequence deleted from cache",{consequenceId:e})}async addControl(e){let t=await this.addListItem("Controls",e);return this._controls.push(t),this.logger.debugLog("Control added to cache",t),t}async updateControl(e,t){await this.updateListItem("Controls",e,t);let s=this._controls.findIndex(i=>i.Id===e);s!==-1&&(this._controls[s]=r(r({},this._controls[s]),t),this.logger.debugLog("Control updated in cache",{controlId:e}))}async deleteControl(e){await this.deleteListItem("Controls",e),this._controls=this._controls.filter(t=>t.Id!==e),this.logger.debugLog("Control deleted from cache",{controlId:e})}selectRisk(e){this.logger.debugLog("Selecting risk",{riskId:e});let t=null;for(let s=0;s<this._risks.length;s++)if(this._risks[s].Id===e){t=this._risks[s];break}if(!t)return this.logger.debugLog("Risk not found",{riskId:e}),this._selectedRisk=null,null;this._selectedRisk=u(r({},t),{Causes:[],Consequences:[],Controls:[],Treatments:[]});for(let s=0;s<this._causes.length;s++)this._causes[s].ParentId===e&&this._selectedRisk.Causes.push(this._causes[s]);for(let s=0;s<this._consequences.length;s++)this._consequences[s].ParentId===e&&this._selectedRisk.Consequences.push(this._consequences[s]);for(let s=0;s<this._controls.length;s++)this._controls[s].ParentId===e&&this._selectedRisk.Controls.push(this._controls[s]);for(let s=0;s<this._treatments.length;s++)this._treatments[s].ParentId===e&&this._selectedRisk.Treatments.push(this._treatments[s]);return this.logger.debugLog("Risk selected with associated items",{riskId:e,causesCount:this._selectedRisk.Causes.length,consequencesCount:this._selectedRisk.Consequences.length,controlsCount:this._selectedRisk.Controls.length,treatmentsCount:this._selectedRisk.Treatments.length}),this._selectedRisk}clearSelectedRisk(){this.logger.debugLog("Clearing selected risk"),this._selectedRisk=null}static \u0275fac=function(t){return new(t||g)(L(p))};static \u0275prov=m({token:g,factory:g.\u0275fac,providedIn:"root"})};export{f as a};
